# üìö DOCUMENTACI√ìN T√âCNICA COMPLETA - SISTEMA LDAP
**Proyecto: Mainly-labs - Implementaci√≥n LDAP**  
**Autor: Juan Ram√≥n Fern√°ndez**  
**Fecha: 23 de septiembre de 2025**  
**Rama: juanrra_implementacion_ldap**

---

## üéØ ARQUITECTURA DEL SISTEMA

### Componentes Principales
- **Django 5.2.6**: Framework web principal
- **OpenLDAP**: Servidor de directorio para autenticaci√≥n
- **django-auth-ldap**: Integraci√≥n Django-LDAP
- **PostgreSQL**: Base de datos relacional (opcional)

### Estructura del Proyecto
```
apps/
‚îî‚îÄ‚îÄ accounts/                    # App principal de autenticaci√≥n
    ‚îú‚îÄ‚îÄ views.py                 # L√≥gica de negocio y vistas
    ‚îú‚îÄ‚îÄ urls.py                  # Rutas URL
    ‚îú‚îÄ‚îÄ forms.py                 # Formularios personalizados
    ‚îú‚îÄ‚îÄ models.py                # Modelos de datos
    ‚îú‚îÄ‚îÄ admin.py                 # Configuraci√≥n admin Django
    ‚îî‚îÄ‚îÄ templates/               # Plantillas HTML
        ‚îú‚îÄ‚îÄ admin/               # Templates gesti√≥n LDAP
        ‚îú‚îÄ‚îÄ dashboard/           # Dashboards por rol
        ‚îú‚îÄ‚îÄ registration/        # Login/registro
        ‚îî‚îÄ‚îÄ home/               # P√°gina principal

project/
‚îú‚îÄ‚îÄ settings.py                  # Configuraci√≥n principal
‚îú‚îÄ‚îÄ urls.py                      # URLs ra√≠z
‚îî‚îÄ‚îÄ wsgi.py                     # Servidor WSGI

Archivos de configuraci√≥n:
‚îú‚îÄ‚îÄ .env                        # Variables de entorno
‚îú‚îÄ‚îÄ .env.example               # Plantilla configuraci√≥n
‚îú‚îÄ‚îÄ requirements.txt           # Dependencias Python
‚îú‚îÄ‚îÄ LDAP_SETUP.md             # Documentaci√≥n instalaci√≥n LDAP
‚îî‚îÄ‚îÄ admin_config.ldif         # Configuraci√≥n admin LDAP
```

---

## üîó MAPEO FUNCIONALIDAD ‚Üí C√ìDIGO

### 1. üö™ SISTEMA DE AUTENTICACI√ìN

#### Login de Usuarios
**Ubicaci√≥n**: `apps/accounts/views.py:38-49`
```python
class CustomLoginView(LoginView):
    template_name = "registration/login.html"
    authentication_form = CustomLoginForm

    def get_success_url(self):
        # Redirect basado en rol del usuario
```
**URL**: `apps/accounts/urls.py:15`
```python
path("login/", views.CustomLoginView.as_view(), name="login")
```
**Template**: `apps/accounts/templates/registration/login.html`
**Formulario**: `apps/accounts/forms.py:CustomLoginForm`

#### Logout Personalizado
**Ubicaci√≥n**: `apps/accounts/views.py:58-68`
```python
def custom_logout_view(request):
    """Logout que acepta GET y POST con mensajes personalizados"""
```
**URL**: `apps/accounts/urls.py:16`
```python
path("logout/", views.custom_logout_view, name="logout")
```

#### Configuraci√≥n LDAP Backend
**Ubicaci√≥n**: `project/settings.py:123-126`
```python
AUTHENTICATION_BACKENDS = [
    'django_auth_ldap.backend.LDAPBackend',    # ‚Üê Autenticaci√≥n principal
    'django.contrib.auth.backends.ModelBackend'  # ‚Üê Fallback local
]
```

**Configuraci√≥n LDAP**: `project/settings.py:131-180`
```python
# Conexi√≥n LDAP
AUTH_LDAP_SERVER_URI = env("AUTH_LDAP_SERVER_URI", default="ldap://localhost:389")
AUTH_LDAP_BIND_DN = env("AUTH_LDAP_BIND_DN", default="")
AUTH_LDAP_BIND_PASSWORD = env("AUTH_LDAP_BIND_PASSWORD", default="")

# B√∫squeda de usuarios
AUTH_LDAP_USER_SEARCH = LDAPSearch(
    env("AUTH_LDAP_USER_DN", default="ou=users,dc=example,dc=com"),
    ldap.SCOPE_SUBTREE,
    env("AUTH_LDAP_USER_FILTER", default="(uid=%(user)s)")
)

# Mapeo atributos LDAP ‚Üí Django
AUTH_LDAP_USER_ATTR_MAP = {
    "first_name": "givenName",
    "last_name": "sn", 
    "email": "mail",
}
```

---

### 2. üë• GESTI√ìN DE USUARIOS LDAP

#### Creaci√≥n de Usuarios LDAP
**Ubicaci√≥n**: `apps/accounts/views.py:101-132`
```python
@user_passes_test(is_admin)
def create_ldap_user(request):
    """Vista para crear usuarios en LDAP (solo admins)"""
```
**Funci√≥n de creaci√≥n**: `apps/accounts/views.py:135-202`
```python
def create_user_in_ldap(username, first_name, last_name, email, password, role, is_staff):
    """Crea usuario en servidor LDAP con asignaci√≥n autom√°tica de grupos"""
```
**URL**: `apps/accounts/urls.py:47`
```python
path("ldap/create-user/", views.create_ldap_user, name="create_ldap_user")
```
**Template**: `apps/accounts/templates/admin/create_ldap_user.html`
**Formulario**: `apps/accounts/forms.py:LDAPUserCreationForm`

#### Listado de Usuarios LDAP
**Ubicaci√≥n**: `apps/accounts/views.py:205-235`
```python
@user_passes_test(is_admin)
def list_ldap_users(request):
    """Lista todos los usuarios del directorio LDAP"""
```
**URL**: `apps/accounts/urls.py:48`
```python
path("ldap/list-users/", views.list_ldap_users, name="list_ldap_users")
```
**Template**: `apps/accounts/templates/admin/list_ldap_users.html`

#### Control de Acceso Admin
**Ubicaci√≥n**: `apps/accounts/views.py:94-96`
```python
def is_admin(user):
    """Verifica si usuario tiene permisos de administrador"""
    return user.is_authenticated and user.role == 'admin'
```

---

### 3. üè† P√ÅGINAS PRINCIPALES

#### P√°gina de Inicio
**Ubicaci√≥n**: `apps/accounts/views.py:53-55`
```python
def home_view(request):
    return render(request, "home/home.html")
```
**URL**: `apps/accounts/urls.py:19`
```python
path("home/", views.home_view, name="home")
```
**Template**: `apps/accounts/templates/home/home.html`

#### Redirect Ra√≠z
**Ubicaci√≥n**: `apps/accounts/urls.py:12`
```python
path("", lambda request: HttpResponseRedirect('/home/'), name="root")
```

---

### 4. üìä SISTEMA DE DASHBOARDS

#### Dashboard Administrador
**Ubicaci√≥n**: `apps/accounts/views.py:82-84`
```python
@login_required
def admin_dashboard(request):
    return render(request, "dashboard/admin_dashboard.html")
```
**URL**: `apps/accounts/urls.py:43`
**Template**: `apps/accounts/templates/dashboard/admin_dashboard.html`

#### Dashboard HR
**Ubicaci√≥n**: `apps/accounts/views.py:86-88`
```python
@login_required
def hr_dashboard(request):
    return render(request, "dashboard/hr_dashboard.html")
```
**URL**: `apps/accounts/urls.py:44`

#### Dashboard T√©cnico
**Ubicaci√≥n**: `apps/accounts/views.py:90-92`
```python
@login_required
def tech_dashboard(request):
    return render(request, "dashboard/tech_dashboard.html")
```
**URL**: `apps/accounts/urls.py:45`

#### Dashboard Usuario
**Ubicaci√≥n**: `apps/accounts/views.py:94-96`
```python
@login_required
def user_dashboard(request):
    return render(request, "dashboard/user_dashboard.html")
```
**URL**: `apps/accounts/urls.py:46`

---

### 5. üë§ GESTI√ìN DE PERFILES

#### Perfil de Usuario
**Ubicaci√≥n**: `apps/accounts/views.py:70-80`
```python
@login_required
def profile(request):
    """Vista para editar perfil de usuario"""
```
**URL**: `apps/accounts/urls.py:22`
**Formulario**: `apps/accounts/forms.py:ProfileForm`

#### Registro Tradicional
**Ubicaci√≥n**: `apps/accounts/views.py:21-30`
```python
class RegisterView(FormView):
    template_name = "registration/registration_form.html"
    form_class = RegistrationForm
```
**URL**: `apps/accounts/urls.py:25`
**Formulario**: `apps/accounts/forms.py:RegistrationForm`

---

### 6. üîß FORMULARIOS PERSONALIZADOS

**Ubicaci√≥n**: `apps/accounts/forms.py`

#### Formulario Login
```python
class CustomLoginForm(AuthenticationForm):
    """Formulario de login personalizado con estilos"""
```

#### Formulario Creaci√≥n LDAP
```python
class LDAPUserCreationForm(forms.Form):
    """Formulario para crear usuarios en LDAP"""
    username = forms.CharField(max_length=150)
    first_name = forms.CharField(max_length=30)
    last_name = forms.CharField(max_length=30)
    email = forms.EmailField()
    password = forms.CharField(widget=forms.PasswordInput)
    role = forms.ChoiceField(choices=[...])
    is_staff = forms.BooleanField(required=False)
```

#### Formulario Registro
```python
class RegistrationForm(UserCreationForm):
    """Formulario de registro con campos adicionales"""
```

#### Formulario Perfil
```python
class ProfileForm(forms.ModelForm):
    """Formulario para editar informaci√≥n del perfil"""
```

---

### 7. üóÑÔ∏è ESTRUCTURA DE DATOS LDAP

#### Estructura del Directorio
```
dc=example,dc=com                           # Base DN
‚îú‚îÄ‚îÄ ou=users,dc=example,dc=com             # Organizational Unit: Usuarios
‚îÇ   ‚îú‚îÄ‚îÄ uid=juanrra,ou=users,dc=example,dc=com
‚îÇ   ‚îú‚îÄ‚îÄ uid=adminuser,ou=users,dc=example,dc=com
‚îÇ   ‚îî‚îÄ‚îÄ uid=helen,ou=users,dc=example,dc=com
‚îî‚îÄ‚îÄ ou=groups,dc=example,dc=com            # Organizational Unit: Grupos
    ‚îú‚îÄ‚îÄ cn=active,ou=groups,dc=example,dc=com      # Usuarios activos
    ‚îú‚îÄ‚îÄ cn=admin,ou=groups,dc=example,dc=com       # Administradores
    ‚îú‚îÄ‚îÄ cn=staff,ou=groups,dc=example,dc=com       # Staff Django
    ‚îú‚îÄ‚îÄ cn=superuser,ou=groups,dc=example,dc=com   # Superusuarios
    ‚îú‚îÄ‚îÄ cn=hr,ou=groups,dc=example,dc=com          # Recursos Humanos
    ‚îî‚îÄ‚îÄ cn=tech,ou=groups,dc=example,dc=com        # T√©cnicos
```

#### Esquema de Usuario LDAP
```ldif
dn: uid=username,ou=users,dc=example,dc=com
objectClass: inetOrgPerson
uid: username                    # Nombre de usuario (√∫nico)
cn: Nombre Completo             # Nombre completo del usuario
sn: Apellido                    # Apellido
givenName: Nombre               # Nombre de pila
mail: email@domain.com          # Direcci√≥n de correo
userPassword: {SSHA}...         # Contrase√±a encriptada
```

#### Asignaci√≥n de Grupos por Rol
**Ubicaci√≥n**: `apps/accounts/views.py:169-185`
```python
# L√≥gica de asignaci√≥n autom√°tica de grupos
groups_to_add = ['active']  # Todos los usuarios activos

if role == 'admin':
    groups_to_add.extend(['admin', 'staff', 'superuser'])
elif role == 'hr':
    groups_to_add.append('hr')
elif role == 'tech':
    groups_to_add.extend(['tech', 'staff'])
else:  # user
    groups_to_add.append('user')
```

---

### 8. ‚öôÔ∏è CONFIGURACI√ìN Y VARIABLES

#### Variables de Entorno
**Archivo**: `.env`
```bash
# Django
DJANGO_SECRET_KEY='secret-key'
DEBUG=True
ALLOWED_HOSTS=localhost,127.0.0.1

# Base de datos
DB_NAME=mainly_labs_db
DB_USER=postgres
DB_PASSWORD=postgres123
DB_HOST=localhost
DB_PORT=5432

# LDAP - Configuraci√≥n crucial
AUTH_LDAP_SERVER_URI=ldap://localhost:389
AUTH_LDAP_BIND_DN=cn=admin,dc=example,dc=com
AUTH_LDAP_BIND_PASSWORD=InterNat

# LDAP - B√∫squeda de usuarios
AUTH_LDAP_USER_DN=ou=users,dc=example,dc=com
AUTH_LDAP_USER_FILTER=(uid=%(user)s)
AUTH_LDAP_GROUP_DN=ou=groups,dc=example,dc=com
```

#### Dependencias Cr√≠ticas
**Archivo**: `requirements.txt`
```
Django==5.2.6                  # Framework web
django-auth-ldap==4.6.0        # Integraci√≥n LDAP
python-ldap==3.4.3             # Cliente LDAP Python
django-environ==0.11.2         # Gesti√≥n variables entorno
psycopg2-binary==2.9.7         # Driver PostgreSQL
```

#### Apps Instaladas
**Ubicaci√≥n**: `project/settings.py:55-74`
```python
INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'apps.accounts',        # ‚Üê App principal
    'apps.assistance',
    'apps.hr',
    'apps.projects_manager',
    'apps.purchase_order',
    'apps.suggestions',
    'apps.tasks_manager',
    'apps.training_course',
]
```

---

### 9. üîí SISTEMA DE SEGURIDAD

#### Decoradores de Seguridad
**Ubicaci√≥n**: `apps/accounts/views.py`
```python
from django.contrib.auth.decorators import login_required, user_passes_test

@login_required                    # Requiere autenticaci√≥n
@user_passes_test(is_admin)       # Solo administradores
```

#### Verificaci√≥n de Permisos
**Ubicaci√≥n**: `apps/accounts/views.py:94-96`
```python
def is_admin(user):
    """Funci√≥n para verificar permisos de administrador"""
    return user.is_authenticated and user.role == 'admin'
```

#### Control de Acceso en URLs
**Ubicaci√≥n**: `apps/accounts/urls.py:47-48`
```python
# Solo admins pueden acceder a gesti√≥n LDAP
path("ldap/create-user/", views.create_ldap_user, name="create_ldap_user"),
path("ldap/list-users/", views.list_ldap_users, name="list_ldap_users"),
```

---

### 10. üé® TEMPLATES Y UI

#### Estructura de Templates
```
apps/accounts/templates/
‚îú‚îÄ‚îÄ base_generic.html                      # Layout base com√∫n
‚îú‚îÄ‚îÄ home/
‚îÇ   ‚îî‚îÄ‚îÄ home.html                         # P√°gina principal
‚îú‚îÄ‚îÄ registration/
‚îÇ   ‚îú‚îÄ‚îÄ login.html                        # Formulario login
‚îÇ   ‚îú‚îÄ‚îÄ registration_form.html            # Formulario registro
‚îÇ   ‚îî‚îÄ‚îÄ profile_form.html                 # Edici√≥n perfil
‚îú‚îÄ‚îÄ dashboard/
‚îÇ   ‚îú‚îÄ‚îÄ admin_dashboard.html              # Dashboard admin
‚îÇ   ‚îú‚îÄ‚îÄ hr_dashboard.html                 # Dashboard HR
‚îÇ   ‚îú‚îÄ‚îÄ tech_dashboard.html               # Dashboard t√©cnico
‚îÇ   ‚îî‚îÄ‚îÄ user_dashboard.html               # Dashboard usuario
‚îî‚îÄ‚îÄ admin/
    ‚îú‚îÄ‚îÄ create_ldap_user.html             # Crear usuario LDAP
    ‚îî‚îÄ‚îÄ list_ldap_users.html              # Listar usuarios LDAP
```

#### Navegaci√≥n Principal
**Ubicaci√≥n**: `apps/accounts/templates/base_generic.html`
- Men√∫ responsive con Bootstrap
- Links din√°micos seg√∫n autenticaci√≥n
- Breadcrumbs autom√°ticos

---

### 11. üîÑ FLUJOS DE TRABAJO PRINCIPALES

#### Flujo: Login de Usuario
1. **URL**: `/login/` ‚Üí `CustomLoginView`
2. **Template**: `registration/login.html`
3. **Proceso**: 
   - Django-auth-ldap busca en LDAP
   - Valida credenciales
   - Crea/actualiza usuario Django
   - Redirect basado en rol

#### Flujo: Creaci√≥n Usuario LDAP
1. **URL**: `/ldap/create-user/` ‚Üí `create_ldap_user()`
2. **Verificaci√≥n**: `@user_passes_test(is_admin)`
3. **Template**: `admin/create_ldap_user.html`
4. **Proceso**:
   - Validaci√≥n formulario
   - Conexi√≥n LDAP admin
   - Creaci√≥n entrada usuario
   - Asignaci√≥n grupos autom√°tica

#### Flujo: Navegaci√≥n Dashboard
1. **Login exitoso** ‚Üí `get_success_url()`
2. **Evaluaci√≥n rol** ‚Üí Redirect apropiado
3. **Dashboard espec√≠fico** ‚Üí Funciones seg√∫n permisos

---

### 12. üêõ DEPURACI√ìN Y LOGS

#### Comandos de Verificaci√≥n LDAP
```bash
# Ver usuarios LDAP
ldapsearch -x -LLL -b "ou=users,dc=example,dc=com"

# Ver grupos LDAP  
ldapsearch -x -LLL -b "ou=groups,dc=example,dc=com"

# Verificar usuario espec√≠fico
ldapsearch -x -LLL -b "ou=users,dc=example,dc=com" "(uid=username)"

# Estado servicio LDAP
systemctl status slapd
```

#### Logs Django
```python
# En views.py - Agregar para debug
import logging
logger = logging.getLogger(__name__)

def create_ldap_user(request):
    logger.info(f"Admin {request.user.username} creando usuario LDAP")
```

#### Variables Debug
**Ubicaci√≥n**: `project/settings.py`
```python
DEBUG = env('DEBUG', default=False)
LOGGING = {
    # Configuraci√≥n logs...
}
```

---

### 13. üìã COMANDOS ADMINISTRATIVOS

#### Gesti√≥n Django
```bash
# Migraciones
python manage.py makemigrations
python manage.py migrate

# Servidor desarrollo
python manage.py runserver

# Shell Django
python manage.py shell

# Superusuario Django (backup)
python manage.py createsuperuser
```

#### Gesti√≥n LDAP
```bash
# Configurar admin LDAP
sudo slappasswd                                    # Generar hash contrase√±a
sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f admin_config.ldif

# Backup/Restore LDAP
slapcat > backup.ldif                             # Backup
sudo systemctl stop slapd                        # Para servicio
sudo rm -rf /var/lib/ldap/*                      # Limpia datos
sudo slapadd < backup.ldif                       # Restaura
sudo systemctl start slapd                       # Inicia servicio
```

---

### 14. üìä M√âTRICAS Y MONITOREO

#### Usuarios Activos
**Comando**: 
```bash
ldapsearch -x -LLL -b "ou=users,dc=example,dc=com" | grep "dn:" | wc -l
```

#### Verificaci√≥n Conectividad
**Ubicaci√≥n**: `apps/accounts/management/commands/test_ldap.py`
```python
# Comando personalizado Django para test LDAP
python manage.py test_ldap
```

#### Health Check LDAP
```bash
# Test conexi√≥n b√°sica
ldapsearch -x -LLL -b "dc=example,dc=com" "(objectClass=*)" | head -5

# Test autenticaci√≥n admin  
ldapsearch -D "cn=admin,dc=example,dc=com" -w InterNat -b "dc=example,dc=com"
```

---

## üéØ RESUMEN EJECUTIVO

### Funcionalidades Implementadas ‚úÖ
- **Autenticaci√≥n LDAP** centralizada y robusta
- **Gesti√≥n completa usuarios** v√≠a web interface
- **Sistema roles** con dashboards espec√≠ficos
- **Integraci√≥n perfecta** LDAP ‚Üî Django
- **Interface administrativa** intuitiva
- **Seguridad multicapa** con decoradores

### Archivos Cr√≠ticos del Sistema
1. **`apps/accounts/views.py`** - L√≥gica principal (248 l√≠neas)
2. **`project/settings.py`** - Configuraci√≥n LDAP
3. **`apps/accounts/urls.py`** - Rutas del sistema
4. **`apps/accounts/forms.py`** - Formularios personalizados
5. **`.env`** - Variables de configuraci√≥n

### Pr√≥ximas Mejoras Sugeridas
- **Eliminaci√≥n usuarios LDAP** desde web interface
- **Edici√≥n masiva** de usuarios
- **Auditor√≠a completa** de cambios
- **API REST** para integraci√≥n externa
- **Dashboard anal√≠tico** con m√©tricas

---

**üìÖ √öltima actualizaci√≥n**: 23 de septiembre de 2025  
**üîß Mantenido por**: Juan Ram√≥n Fern√°ndez  
**üìß Contacto**: aljuanrra914@gmail.com  
**üåê Repositorio**: https://github.com/itprogerspain/Mainly-labs/tree/juanrra_implementacion_ldap

---